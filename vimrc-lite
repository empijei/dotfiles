set nocompatible  "Be IMproved
syntax on
let mapleader = "\\"
scriptencoding utf-8
set encoding=utf-8

"Faster way to access the terminal
command! T :terminal
command! TT :tab terminal

"useful misc commands and shortcuts{{{
"For Hex view
command! Hex :%!xxd
command! NoHex :%!xxd -r
"By default BOOKMARKSs are highlighted
let @/="BOOKMARK"
command! C let @/="BOOKMARK"

command! LineEndings e ++ff=dos<CR>

"delete empty lines
command! Strip g/^\s*$/d
"delete trailing spaces
command! StripEnding :%s/\s\+$//e

"Toggle between vimdiff and vim
command! Diff windo diffthis | syntax off
command! NoDiff diffoff! | syntax on

"esc key is a serious overstretch
inoremap jk <esc>

"Copy filename and fullfilepath to clipboard
nnoremap c% :let @+=expand("%")<CR>

"Move through vimgrep results less awkwardly
nnoremap cn :cn<CR>
nnoremap cp :cp<CR>

" Some useful settings
set ffs=unix,dos "fileformat for CLRF madness
set list "shows invisible characters
set wrap "Wrapping lines
set path+=** "use globstar for matching
set t_Co=256 "Extended colors for terminal
set number "line numbers
set mouse=a "mouse integration
set showcmd "Show partial commands
set history=10000 "command history size
set undodir=~/.vim/undo/ "tell vim where to look for undo files
set tabstop=2 "prints the tab character as 2 spaces
set hlsearch "highlights search result. use :C to clear
set wildmenu "show commands in statusline
set modeline "see http://vim.wikia.com/wiki/Modeline_magic
set undofile "tell vim to use an undo file
set wildmode=longest,full "Show list of completion in modeline while typing command
set omnifunc=syntaxcomplete#Complete "http://vim.wikia.com/wiki/Omni_completion
set ttymouse=xterm2 "Resize splits with mouse while inside screen
set expandtab "converts tabs to spaces
set smartcase "search insensitive if no uppercase letters appear in the search pattern
set incsearch "move while searching
set directory=~/.vim/directory/ "move swap files out of current dir
set scrolloff=7 "Always keep at least some lines of visible context around cursor
set listchars=tab:\Â·\  "Prints tabs as middle dot
set fillchars+=vert:\ "removes pipe marker in split
set clipboard=unnamedplus "System clipboard integration
set cursorline "underline current line
set ignorecase "default for smartcase
set foldmethod=marker "Foldings with {{{ }}} sections
set cryptmethod=blowfish2 "Crypto stronger than default
set shiftwidth=2 "column to reindent on reindent command
set timeoutlen=500
set colorcolumn=80 "Mark the 80th character
set foldlevelstart=20 "Folds are opened by default

"Remapping for tab movements
"nnoremap <Leader>tn :tabnext<CR>
"nnoremap <Leader>tp :tabprev<CR>
command! TN :tabnext
command! TP :tabprev

"statusline {{{
set laststatus=2
set ttimeoutlen=50
function! InsertStatuslineColor(mode)
  " 0 = Dark Gray
  " 1 = Red
  " 2 = Lime
  " 3 = Yellow
  " 4 = Cyan
  " 5 = Pink
  " 6 = Aquamarine
  " 7 = White
  if a:mode == 'i'
    hi StatusLine term=reverse ctermbg=16 ctermfg=7
  elseif a:mode == 'r'
    hi StatusLine term=reverse ctermbg=16 ctermfg=1
  else
    hi StatusLine term=reverse ctermbg=16 ctermfg=7
  endif
endfunction

" Disable line numbers in terminal windows
au BufWinEnter * if &buftype == 'terminal' | setlocal nonumber | endif

au InsertEnter * call InsertStatuslineColor(v:insertmode)
au InsertChange * call InsertStatuslineColor(v:insertmode)
au InsertLeave * hi StatusLine term=reverse ctermbg=16 ctermfg=2
hi StatusLine term=reverse ctermbg=16 ctermfg=2
set statusline=%<\ %n:%f\ %m%r%y%=%35.(line:\ %l\ of\ %L,\ col:\ %c%V\ [%P]%)
"}}}

"Ctrl-s to save
"WARNING: you have to put
"stty -ixon
"in your bashrc file or this will not work
inoremap <c-s> <esc>:w<CR>a

" Use ctrl-space to autocomplete
inoremap <C-Space> <C-x><C-o>
inoremap <C-@> <C-Space>

"move lines on Ctrl+Arrows
nnoremap <c-j> :m .+1<CR>==
nnoremap <c-k> :m .-2<CR>==
inoremap <c-j> <Esc>:m .+1<CR>==gi
inoremap <c-k> <Esc>:m .-2<CR>==gi

colorscheme default
highlight ColorColumn ctermbg=black
highlight Search cterm=NONE ctermbg=yellow ctermfg=black
highlight Visual cterm=NONE ctermbg=yellow ctermfg=black
highlight SpellBad cterm=NONE ctermfg=black ctermbg=red
highlight SpellCap cterm=NONE ctermfg=white ctermbg=blue
"
"GVim default theme is seriously ugly
if has('gui_running')
  colorscheme torte
endif

"Toggle wrapping when needed
noremap <silent> <Leader>w :call ToggleWrap()<CR>
function! ToggleWrap()
  if &wrap
    echo "Wrap OFF"
    set nowrap
  else
    echo "Wrap ON"
    set wrap
  endif
endfunction

"Break bad habits
nnoremap <Up> <NOP>
nnoremap <Down> <NOP>
nnoremap <Left> <NOP>
nnoremap <Right> <NOP>

" & is close to * so it makes sense to have them behave similarly
nnoremap & #

"Avoid stupid typos
command! W :w
command! Q :q
command! WQ :wq
command! Wq :wq

"Call grep from Vim. I know there is :vimgrep, but it is too slow.
command! -nargs=+ Grep execute 'silent grep! -I -r -n --exclude-dir=.git --exclude tags --exclude \*.cf . -e <args>' | copen | execute 'silent /<args>' | redraw!
nnoremap <leader>g :Grep <c-r>=expand("<cword>")<cr><cr>

" VimDiff shortcuts
" https://gist.github.com/karenyyng/f19ff75c60f18b4b8149
if &diff
  " Get from remote
  nnoremap dr :diffg<Space>RE<CR>
  " Get from base
  nnoremap db :diffg<Space>BA<CR>
  " Get from local
  nnoremap dl :diffg<Space>LO<CR>
  " Next diff
  nnoremap cn ]c
  " Previous diff
  nnoremap cp [c
endif

highlight ExtraWhitespace ctermbg=red
match ExtraWhitespace /\s\+$/

" Netrw File explorer config in case NERDTree is not available
let g:netrw_banner = 0
let g:netrw_liststyle = 3
let g:netrw_browse_split = 2
let g:netrw_altv = 1
let g:netrw_winsize = 25
map <C-n> :Vexplore<CR>
